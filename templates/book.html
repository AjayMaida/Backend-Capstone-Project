{% extends 'base.html' %}
{% block content %}
<h1>Make a reservation</h1>

<form id="bookingForm">
    <p>
        <label>First name</label><br>
        <input type="text" id="first_name">
    </p>

    <!-- Part 1 -->
    <p>
        <label>Reservation date</label><br>
        <input type="date" id="reservation_date">
    </p>

    <p>
        <label>Reservation slot</label><br>
        <select id="reservation_slot"></select>
    </p>

    <button type="submit">Reserve Now</button>
</form>

<h2>Bookings</h2>
<div id="bookings_container"></div>

<script>
console.log('Hello');

function formatTime(i) {
    var hour = parseInt(i);
    var period = 'AM';
    if (hour >= 12) {
        period = 'PM';
    }
    var display = hour;
    if (hour > 12) display = hour - 12;
    return display + ':00 ' + period;
}

document.getElementById('reservation_date').value = new Date().toISOString().split('T')[0];

document.getElementById('reservation_date').addEventListener('change', function() {
    getBookings();
});

function getBookings() {
    var date = document.getElementById('reservation_date').value;
    fetch('/bookings/?date=' + date)
        .then(response => response.json())
        .then(data => {
            const reserved_slots = [];
            var bookings_html = '';
            for (const item of data) {
                console.log(item.fields);
                reserved_slots.push(item.fields.reservation_slot);
                bookings_html += `<p>${item.fields.first_name} - ${formatTime(item.fields.reservation_slot)}</p>`;
            }

            if (data.length === 0) {
                bookings_html = '<p>No Bookings</p>';
            }
            document.getElementById('bookings_container').innerHTML = bookings_html;

            let slot_options = '<option value="0" disabled>Select time</option>';
            for (let i = 11; i < 20; i++) {
                const label = formatTime(i);
                if (reserved_slots.includes(i)) {
                    slot_options += `<option value=${i} disabled>${label}</option>`;
                } else {
                    slot_options += `<option value=${i}>${label}</option>`;
                }
            }
            document.getElementById('reservation_slot').innerHTML = slot_options;
        });
}

getBookings();

document.getElementById('bookingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const payload = {
        first_name: document.getElementById('first_name').value,
        reservation_date: document.getElementById('reservation_date').value,
        reservation_slot: document.getElementById('reservation_slot').value
    };
    fetch('/bookings/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(resp => resp.json())
    .then(result => {
        if (result && result.success === 1) {
            getBookings();
        } else {
            alert('Slot already booked or error occurred');
        }
    })
    .catch(err => {
        alert('Error: ' + err);
    });
});
</script>
{% endblock %}
